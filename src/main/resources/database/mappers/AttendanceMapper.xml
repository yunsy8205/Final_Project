<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.cloud.pt.attendance.AttendanceDAO">
	<select id="getNum" resultType="java.lang.Long" parameterType="java.util.Map">
		SELECT ATTENDANCENUM
		FROM ATTENDANCE
		WHERE WORKDATE=#{modify.modifyDate}
		AND EMPLOYEENUM=#{emp.employeeNum}
	</select>

	<select id="getInfo" resultMap="getInfoResult" parameterType="AttendanceVO">
		SELECT A.*, E.*
		FROM ATTENDANCE A 
			JOIN EMPLOYEE E
			ON A.EMPLOYEENUM=E.EMPLOYEENUM
		WHERE E.EMPLOYEENUM=#{employeeNum}
		AND A.WORKDATE=DATE_FORMAT(NOW(), '%Y-%m-%d')
	</select>
	
	<resultMap type="EmployeeVO" id="getInfoResult">
		<id column="EMPLOYEENUM" property="employeeNum"/>
		<result column="NAME" property="name"/>
		<result column="LEAVEDATE" property="leaveDate"/>
		<collection property="list" javaType="java.util.List" ofType="AttendanceVO">
			<id column="ATTENDANCENUM" property="attendanceNum"/>
				<result column="EMPLOYEENUM" property="employeeNum"/>
				<result column="WORKDATE" property="workDate"/>
				<result column="ONTIME" property="onTime"/>
				<result column="OFFTIME" property="offTime"/>
				<result column="STATE" property="state"/>
		</collection>
	</resultMap>	
	
	<select id="getModifyList" resultMap="getListResult" parameterType="EmployeeVO">
		SELECT AM.*, E.NAME 
		FROM ATTENDANCEMODIFY AM 
			JOIN ATTENDANCE A
			ON AM.ATTENDANCENUM=A.ATTENDANCENUM
			JOIN EMPLOYEE E
			ON A.EMPLOYEENUM=E.EMPLOYEENUM
		WHERE E.EMPLOYEENUM=#{employeeNum}
		ORDER BY AM.REGDATE DESC
	</select>
	
	<resultMap type="AttendanceVO" id="getListResult">
		<id column="ATTENDANCENUM" property="attendanceNum"/>
		<association property="attendanceModifyVO" javaType="AttendanceModifyVO">
			<id column="ATTENDANCEMODIFYNUM" property="attendanceModifyNum"/>
				<result column="ATTENDANCENUM" property="attendanceNum"/>
				<result column="REGDATE" property="regDate"/>
				<result column="MODIFYDATE" property="modifyDate"/>
				<result column="MODIFYTIME" property="modifyTime"/>
				<result column="STATE" property="state"/>
		</association>
		<association property="employeeVO" javaType="EmployeeVO">
			<id column="EMPLOYEENUM" property="attendanceNum"/>
				<result column="NAME" property="name"/>
		</association>
	</resultMap>

	<insert id="setModifyAdd" parameterType="AttendanceModifyVO">
		INSERT INTO ATTENDANCEMODIFY
		(ATTENDANCENUM,REGDATE,MODIFYDATE,MODIFYTIME,REQUESTCONTENTS,TYPE,STATE)
		VALUES (#{attendanceNum},NOW(),#{modifyDate},#{modifyTime},#{requestContents},#{type},'요청')
	</insert>
</mapper>